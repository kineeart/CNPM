import { Order } from "../models/order.model.js";
import { Payment } from "../models/payment.model.js";

export const createPayment = async (req, res) => {
  try {
    const { orderId, method } = req.body;

    if (!orderId || !method) {
      return res.status(400).json({ message: "Thiáº¿u thÃ´ng tin orderId hoáº·c method" });
    }

    const order = await Order.findByPk(orderId);
    if (!order) {
      return res.status(404).json({ message: "KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng" });
    }

    // ğŸ”¹ Giáº£ láº­p thanh toÃ¡n (online hoáº·c COD)
    let paymentStatus = "SUCCESS";
    let orderStatus = "success";
    let transactionId = null;

    if (method === "CASH") {
      orderStatus = "delivering";
      transactionId = `COD-${Date.now()}`;
    } else {
      transactionId = `TXN-${Date.now()}`;
    }

    // ğŸ”¹ Táº¡o báº£n ghi thanh toÃ¡n
    const payment = await Payment.create({
      orderId,
      method,
      amount: order.totalPrice,
      status: paymentStatus,
      transactionId
    });

    // ğŸ”¹ Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n
    order.status = orderStatus;
    await order.save();

    res.status(201).json({
      message: "ğŸ’³ Thanh toÃ¡n thÃ nh cÃ´ng!",
      payment,
      orderStatus: order.status
    });
  } catch (error) {
    console.error("ğŸ”¥ Lá»—i khi thanh toÃ¡n:", error);
    res.status(500).json({ message: "Lá»—i server", error: error.message });
  }
};
